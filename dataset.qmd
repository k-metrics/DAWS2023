```{r setup, echo=FALSE, include=FALSE}
source("./R/setup.R")
```

# データセット
　Rではデータセットを用いることで効率的な分析が行えるようになっています。

　  

## データセットとは
　Rにおけるデータセットとは分析対象となるデータの集まりを意味します。例えば、下表のような車の諸元をまとめたものはデータセットです。
```{r, echo=FALSE}
datasets::mtcars %>% 
  df_print()
```
　表計算ソフトで例えるとファイルをR Commanderとした場合、各シートがデータセット、シート内の各列がデータセット内の変数というイメージになりますので、データセット自体は複数持つことが可能です。  

　Rではこのようなデータセットを`data.frame`型という変数型を用いて一つの変数として扱っています。`data.frame`型変数は**Tidy data（整然データ）**[^1]という概念を満たすデータになります。

[^1]: [Wikipedia](https://ja.wikipedia.org/wiki/Tidy_data)

:::{.callout-tip}
## Tip: Tidy data（整然データ）
以下の条件を満たす表型のデータをTidy dataといい、構造と意味が合致しているのが特徴です。  
　1. 個々の変数が一つの列をなす  
　2. 個々の観測が一つの行をなす  
　3. 個々の値が一つのセルをなす  
　4. 個々の観測の構成単位の累計が一つの表をなす  

なので、神ExcelはTidy dataにはなりませんのでRでそのまま扱うことはできません。
:::

　  

### data.frame型
　`data.frame`型変数は以下のような構造を取る変数型で、複数の変数を扱うことができます。このデータセットでは11個の実数型変数（`num`）からなる32組の観測（車種）があることがわかります。
```{r, echo=FALSE}
str(mtcars)
```

　実数型以外にも整数型・文字型・論理型・日付型・因子型などの様々な変数を混在させることが可能です。

　  

## 組み込みデータセット
　Rには様々なデータセットがあらかじめ組み込まれています。テキストP36のパッケージ付属データと同義です。標準で用意されている`datasets`パッケージには様々なデータセットが組み込まれています。代表的なデータセットを簡単に紹介しておきます。

　  

### Iris flower data set
　統計学の世界で最も有名な「フィッシャーのアヤメ」のデータセットです。
```{r, eval=FALSE}
datasets::iris
```
```{r, echo=FALSE}
iris %>% 
  df_print()
```
　三品種のアヤメの花の大きさを計測したデータで、萼片（Sepal）と花弁（Petal）の計測値が各50組、計150組が格納されています。品種（`Species`）は因子型と呼ばれる変数型になっており、層別処理を行う際に便利です。
```{r, echo=FALSE}
str(iris)
```

　  

### New York Air Quarity Measurements
　1973年5月から9月にかけてニューヨークで観測された大気データのデータセットで欠損値（欠測値）が含まれています。
```{r, eval=FALSE}
datasets::airquality
```
```{r, echo=FALSE}
airquality %>% 
  df_print()
```
　オゾン濃度、日射量、風速、気温の測定値と月、日のデータが格納されている一種の時系列のデータセットです。6変数のすべてが数値型ですが、整数型（`int`）と実数型（`num`）が混在しています。欠損値（欠測値）は`NA`と表示されます。
```{r, echo=FALSE}
str(airquality)
```

　  

## データセットを作成する
　R Commanderにはデータセットを作成するための機能が組み込まれていますが、Excelのような表計算ソフトを使ってデータファイルをを作成した方が早くて便利ですし融通が利きます。R Commanderが対応している代表的なファイル形式はxls形式、xlsx形式、CSV形式です。変数名などに日本語が含まれるデータをCSV形式でファイルに保存する場合は必ず**UTF-8エンコーディングを指定**してください。  
　R Commanderの読み込み処理ではエンコーディングが指定できないために日本語版Excelがデフォルトで書き出すシフトJISエンコーディングされた日本語を含むCSVファイルを読み込もうとするとエラーになります[^2]。

[^2]: R 4.2からデフォルトロケール（エンコーディング）をシフトJISからUTF-8に変更したために起こる日本語版Windows特有の問題です。

　  

### R Commanderのためのデータセット
　R CommanderではGUI操作の弊害で様々なオプションの指定ができないためエンコーディング以外に下記の条件を満たすファイルを作成することで読み込み時のエラーを回避することができます。

1. Tidy data形式を守る
    * 神Excelにしない
2. 一行目には必ず変数名を記載する
    * 変数名に（`_`,`-`を除く）記号・空白を使わない
    * 変数名の最初の文字を数字・記号（`_`,`-`）にしない
        * これらはRの変数名に対する制限です
3. 各列の行数を合わせる
    * 行数が合わないと自動的に先頭からのデータを用いて行数が一致するように埋めてしまう場合があります
    * 欠損値（欠測値）の扱いに関しては、明示的に`NA`と文字を入力するか空白（何も入力しない）にするかルールをあらかじめ決めておく
        * `NA`を使うと表計算ソフト側でうまく処理できなくなる可能性があります

　  

## データセットを読み込む
　R Commanderでデータセットのファイルを読み込むには［データ］メニューを使います。

　  

### CSV(UTF-8)形式の場合
　［データ］-［データのインポート］-［テキストファイルまたはクリップボード,URL から...］を実行すると下図のようなダイアログが開きます。  

![条件設定ダイアログ](./fig/01-01.ReadCSV.png)

　各設定項目の意味は

設定項目               | 設定内容
-----------------------|-------------------------------------------------------
データセット名を入力   | データセットの変数名を指定
ファイル内に変数名あり | 一行目が変数名か否か
文字変数を因子に変換   | 文字型変数を因子型変数に変換するか否か
欠測値の記号           | 欠損値（欠測値）を意味する文字を指定
データファイルの場所   | 読み込ませたいデータの位置を指定
フィールドの区切り記号 | CSVの場合は「カンマ」、TSVの場合は「タブ」
小数点の記号           | 通常は「ピリオド」

　データファイルの場所をローカルファイルシステムまたはインターネットのURLにして
［OK］ボタンをクリックします。ローカルファイルの場合はファイルダイアログが、インターネットURLの場合は入力ダイアログが開きますのでダイアログに合わせた操作を行ってください。

　  

### xls形式／xlsx形式の場合
　［データ］-［データのインポート］-［エクセルファイルから...］を実行すると下図のようなダイアログが開きます。


![条件設定ダイアログ](./fig/01-02.ReadExcel.png)

　各設定項目の意味は

設定項目                        | 設定内容
--------------------------------|----------------------------------------------
データセット名を入力            | データセットの変数名を指定
スプレッドシートの1行目の変数名 | 一行目が変数名か否か
スプレッドシートの1列目の行名   | 一列目が行名か否か
文字列を因子に変換              | 文字型変数を因子型変数に変換するか否か
欠測値の記号                    | 欠損値（欠測値）を意味する文字を指定

　各設定項目を設定後、［OK］ボタンをクリックするとファイルダイアログが開きますので読み込みたいファイルを指定してください。なお、ファイル内に複数のシートがある場合は最初のシートだけを読み込みます。GUI操作では任意のシートを読み込むことはできません。

　  

### .RData形式の場合
　［データ］-［データセットのロード...］を実行するとファイル選択ダイアログが開きますので読み込みたい`.RData`形式のファイルを指定します。読み込むと自動的にアクティブデータセットに読み込んだデータセット名が表示されます。  
　サンプルで提供されているファイルに格納されているデータセット名は下表の通りです。なお、データセット名が同一のファイルを読み込んだ場合、確認なしで上書きされます。

ファイル名                       | データセット名
---------------------------------|---------------------------------------------
バイタル.RData                   | VitalSign
外来患者ストレス.RData           | PatientStress
外来患者ストレス(元データ).RData | PatientStress

　  

## アクティブデータセット
　R Commanderには**アクティブデータセット**という概念があります。アクティブデータセットとは計算対象となるデータセットのことで、指定されていないと統計用の算出やグラフによる可視化ができません。

:::{.callout-tip}
## Tip: アクティブデータセット
「アクティブデータセット」はR Commander特有の概念です。R CommanderはRの機能（関数）を利用していますので、Rでも同様の機能を利用することは可能ですが、アクティブなデータセットを常に意識する必要があり参照間違いや変数名のコンフリクトを起こしやすいためRで利用することはおすゝめできません。
:::

　  

---
